# 性能测试设计文档

## 概述

本文档描述了GitHub Action调度器项目的完整性能测试方案。测试套件旨在全面评估系统在不同负载场景下的性能表现，特别关注Java 21虚拟线程在高并发场景下的优势。

## 测试架构

### 测试类结构

```
src/test/java/com/scheduler/performance/
├── PerformanceTestSuite.java    # 综合性能测试套件
├── LoadTest.java                # 负载测试
├── StressTest.java              # 压力测试
└── README.md                    # 详细文档
```

## 测试场景

### 1. PerformanceTestSuite - 综合性能测试

#### 1.1 吞吐量测试
- **目标**: 测试系统在固定时间内能处理的请求数量
- **参数**: 1000请求，60秒
- **指标**: 吞吐量（请求/秒）
- **预期**: >10 请求/秒

#### 1.2 响应时间测试
- **目标**: 测试系统在不同负载下的响应时间分布
- **参数**: 500请求，20并发
- **指标**: P50, P95, P99响应时间
- **预期**: 
  - P95 < 5秒
  - P99 < 10秒

#### 1.3 高并发压力测试
- **目标**: 测试系统在极高并发下的表现
- **参数**: 1000并发请求
- **指标**: 成功率
- **预期**: >80%成功率

#### 1.4 虚拟线程性能测试
- **目标**: 验证虚拟线程在高并发场景下的优势
- **参数**: 10000请求，使用虚拟线程执行器
- **指标**: 吞吐量
- **预期**: >50 请求/秒

#### 1.5 长时间稳定性测试
- **目标**: 测试系统在长时间运行下的稳定性
- **参数**: 5分钟持续负载，10请求/秒
- **指标**: 成功率
- **预期**: >95%成功率

#### 1.6 资源使用测试
- **目标**: 监控系统在负载下的资源使用情况
- **参数**: 500请求
- **指标**: 内存使用
- **预期**: 内存使用 < 最大内存的80%

### 2. LoadTest - 负载测试

#### 2.1 轻负载测试
- **并发数**: 10
- **总请求**: 100
- **预期吞吐量**: >50 req/s
- **预期P95响应时间**: <2s
- **预期成功率**: >99%

#### 2.2 中等负载测试
- **并发数**: 50
- **总请求**: 500
- **预期吞吐量**: >30 req/s
- **预期P95响应时间**: <5s
- **预期成功率**: >95%

#### 2.3 重负载测试
- **并发数**: 100
- **总请求**: 1000
- **预期吞吐量**: >20 req/s
- **预期P95响应时间**: <10s
- **预期成功率**: >90%

### 3. StressTest - 压力测试

#### 3.1 突发流量测试
- **场景**: 模拟短时间内大量请求涌入
- **参数**: 500请求在1秒内发送
- **预期**: >70%成功率

#### 3.2 逐步增加负载测试
- **场景**: 模拟负载逐步增加的情况
- **负载级别**: 10, 25, 50, 100, 200, 500并发
- **预期**: 每个级别 >80%成功率

#### 3.3 系统恢复测试
- **场景**: 测试系统在过载后的恢复能力
- **阶段1**: 2000请求过载
- **阶段2**: 10秒恢复期
- **阶段3**: 100请求正常负载
- **预期**: 恢复后 >95%成功率

## 性能指标

### 关键指标定义

1. **吞吐量 (Throughput)**
   - 单位：请求/秒 (req/s)
   - 表示系统在单位时间内能处理的请求数量

2. **响应时间 (Response Time)**
   - P50: 50%的请求响应时间小于此值
   - P95: 95%的请求响应时间小于此值
   - P99: 99%的请求响应时间小于此值

3. **成功率 (Success Rate)**
   - 成功处理的请求占总请求的百分比
   - 目标：>95%

4. **资源使用 (Resource Usage)**
   - 内存使用量
   - CPU使用率
   - 线程数

## 测试执行

### 运行方式

#### 使用Maven
```bash
# 运行所有性能测试
mvn test -Dtest="*Performance*,*LoadTest*,*StressTest*"

# 运行特定测试类
mvn test -Dtest=PerformanceTestSuite
mvn test -Dtest=LoadTest
mvn test -Dtest=StressTest

# 运行特定测试方法
mvn test -Dtest=PerformanceTestSuite#testThroughput
```

#### 使用脚本

**Windows (PowerShell):**
```powershell
.\run-performance-tests.ps1 all
.\run-performance-tests.ps1 suite
.\run-performance-tests.ps1 load
.\run-performance-tests.ps1 stress
```

**Linux/Mac (Bash):**
```bash
chmod +x run-performance-tests.sh
./run-performance-tests.sh all
./run-performance-tests.sh suite
./run-performance-tests.sh load
./run-performance-tests.sh stress
```

## 测试报告

### 报告格式

每个测试完成后会输出详细的性能报告，包括：

```
性能测试报告: [测试名称]
  总请求数: [数量]
  成功: [数量], 失败: [数量]
  响应时间 (ms):
    最小值: [ms]
    最大值: [ms]
    平均值: [ms]
    P50: [ms]
    P95: [ms]
    P99: [ms]
```

### 结果分析

1. **吞吐量分析**: 评估系统处理能力
2. **响应时间分析**: 识别性能瓶颈
3. **成功率分析**: 评估系统稳定性
4. **资源使用分析**: 评估资源效率

## 性能基准

### 预期性能指标汇总

| 测试场景 | 并发数 | 吞吐量 | P95响应时间 | 成功率 |
|---------|--------|--------|-------------|--------|
| 轻负载 | 10 | >50 req/s | <2s | >99% |
| 中等负载 | 50 | >30 req/s | <5s | >95% |
| 重负载 | 100 | >20 req/s | <10s | >90% |
| 高并发 | 1000 | >10 req/s | <30s | >80% |
| 虚拟线程 | 10000 | >50 req/s | <20s | >90% |

## 虚拟线程优势验证

### 测试重点

1. **高并发处理能力**: 验证虚拟线程能处理大量并发请求
2. **资源效率**: 验证虚拟线程的资源使用效率
3. **响应时间**: 验证虚拟线程在响应时间上的优势

### 预期结果

- 虚拟线程能处理比传统线程池更多的并发请求
- 在相同负载下，虚拟线程的响应时间更稳定
- 虚拟线程的内存占用更低

## 注意事项

1. **测试环境**: 
   - 确保测试环境有足够的资源（CPU、内存）
   - 建议在独立的测试环境中运行

2. **网络延迟**: 
   - 本地测试网络延迟较低
   - 生产环境可能有所不同，需要调整预期值

3. **预热**: 
   - JVM需要预热才能达到最佳性能
   - 某些测试包含预热阶段

4. **超时设置**: 
   - 某些测试设置了较长的超时时间
   - 请耐心等待测试完成

5. **资源监控**: 
   - 建议在测试时监控系统资源使用情况
   - 使用JVM监控工具（如JVisualVM）

## 持续改进

根据测试结果，可以：

1. **优化配置**: 调整虚拟线程配置
2. **代码优化**: 优化Runner服务实现
3. **超时策略**: 调整超时和重试策略
4. **资源管理**: 优化资源使用

## 参考文档

- [性能测试详细文档](src/test/java/com/scheduler/performance/README.md)
- [项目主README](README.md)
- [Java 21虚拟线程文档](https://openjdk.org/jeps/444)
